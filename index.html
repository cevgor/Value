<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitLife — Твой фитнес-компаньон</title>

    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
        }
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            font-weight: 600;
            color: #666;
        }
        .nav-tabs .nav-link.active {
            background: #667eea;
            color: white;
        }
        .tab-pane {
            padding: 25px;
            animation: fadeIn 0.6s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-primary {
            background: #667eea;
            border: none;
        }
        .btn-primary:hover {
            background: #764ba2;
        }
        .list-group-item {
            border-radius: 12px !important;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .list-group-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #total-calories {
            font-size: 1.4rem;
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card animate__animated animate__fadeIn">
            <div class="card-header bg-white text-center py-4">
                <h1 class="mb-0 text-primary">FitLife</h1>
                <p class="text-muted">Твой личный помощник в фитнесе и здоровье</p>
            </div>

            <div class="card-body p-0">
                <!-- Вкладки -->
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item flex-fill text-center" role="presentation">
                        <button class="nav-link active w-100" id="calc-tab" data-bs-toggle="tab" data-bs-target="#calc" type="button">
                            <i class="bi bi-calculator"></i> Калькулятор
                        </button>
                    </li>
                    <li class="nav-item flex-fill text-center" role="presentation">
                        <button class="nav-link w-100" id="food-tab" data-bs-toggle="tab" data-bs-target="#food" type="button">
                            <i class="bi bi-basket"></i> Питание
                        </button>
                    </li>
                    <li class="nav-item flex-fill text-center" role="presentation">
                        <button class="nav-link w-100" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button">
                            <i class="bi bi-graph-up"></i> Прогресс
                        </button>
                    </li>
                    <li class="nav-item flex-fill text-center" role="presentation">
                        <button class="nav-link w-100" id="reminders-tab" data-bs-toggle="tab" data-bs-target="#reminders" type="button">
                            <i class="bi bi-bell"></i> Напоминания
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- 1. Калькулятор -->
                    <div class="tab-pane fade show active" id="calc">
                        <h4 class="text-center mb-4">Расчёт калорий</h4>
                        <form id="user-form" class="row g-3">
                            <div class="col-md-6"><input type="number" class="form-control" placeholder="Возраст" id="age" required></div>
                            <div class="col-md-6">
                                <select class="form-select" id="gender" required>
                                    <option value="male">Мужской</option>
                                    <option value="female">Женский</option>
                                </select>
                            </div>
                            <div class="col-md-6"><input type="number" class="form-control" placeholder="Рост (см)" id="height" required></div>
                            <div class="col-md-6"><input type="number" class="form-control" placeholder="Вес (кг)" id="weight" required></div>
                            <div class="col-md-6">
                                <select class="form-select" id="activity" required>
                                    <option value="1.2">Сидячий</option>
                                    <option value="1.375">Лёгкая</option>
                                    <option value="1.55">Умеренная</option>
                                    <option value="1.725">Высокая</option>
                                    <option value="1.9">Очень высокая</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="goal" required>
                                    <option value="loss">Похудение</option>
                                    <option value="gain">Набор мышц</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-primary w-100" onclick="calculateCalories()">Рассчитать</button>
                            </div>
                        </form>
                        <div id="results" class="mt-4"></div>
                        <div id="tips" class="mt-3"></div>
                    </div>

                    <!-- 2. Питание -->
                    <div class="tab-pane fade" id="food">
                        <h4 class="text-center mb-4">Дневник питания</h4>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="food-search" placeholder="Поиск еды (на англ.: apple, chicken...)" aria-label="Поиск еды">
                            <button class="btn btn-outline-primary" type="button" onclick="searchFood()">Поиск</button>
                        </div>
                        <div id="food-search-results" class="list-group mb-3" style="max-height:250px;overflow-y:auto;"></div>

                        <ul id="food-list" class="list-group mb-3"></ul>
                        <div id="total-calories" class="text-center">Итого: 0 ккал</div>

                        <div class="mt-3 text-center">
                            <label for="date" class="form-label">Дата:</label>
                            <input type="date" id="date" class="form-control w-auto d-inline-block" onchange="loadDay()">
                        </div>
                    </div>

                    <!-- 3. Прогресс -->
                    <div class="tab-pane fade" id="chart">
                        <h4 class="text-center mb-4">Калории за неделю</h4>
                        <canvas id="calorie-chart" height="200"></canvas>
                    </div>

                    <!-- 4. Напоминания -->
                    <div class="tab-pane fade" id="reminders">
                        <h4 class="text-center mb-4">Напоминания</h4>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="reminder-text" placeholder="Например: Выпить витамины">
                            <input type="time" class="form-control" id="reminder-time">
                            <button class="btn btn-primary" onclick="addReminder()">Добавить</button>
                        </div>
                        <ul id="reminder-list" class="list-group"></ul>
                        <small class="text-muted d-block mt-3 text-center">
                            <i class="bi bi-info-circle"></i> Напоминания работают только пока вкладка открыта (браузер покажет уведомление).
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_KEY = 'DEMO_KEY';
        const USDA_API = 'https://api.nal.usda.gov/fdc/v1/foods/search';

        let dailyData = JSON.parse(localStorage.getItem('dailyData')) || {};
        let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
        let currentDate = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = currentDate;

        let chart;

        // Калькулятор
        function calculateCalories() {
            const age = parseFloat(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const activity = parseFloat(document.getElementById('activity').value);
            const goal = document.getElementById('goal').value;

            let bmr = gender === 'male'
                ? 66.5 + (13.75 * weight) + (5.003 * height) - (6.75 * age)
                : 655.1 + (9.563 * weight) + (1.850 * height) - (4.676 * age);

            const tdee = bmr * activity;
            const recommended = goal === 'loss' ? tdee - 500 : tdee + 500;

            document.getElementById('results').innerHTML = `
                <div class="alert alert-info">
                    <strong>BMR:</strong> ${bmr.toFixed(0)} ккал<br>
                    <strong>TDEE:</strong> ${tdee.toFixed(0)} ккал<br>
                    <strong>Цель:</strong> ${recommended.toFixed(0)} ккал/день
                </div>
            `;

            const tips = goal === 'loss'
                ? `<div class="alert alert-success">Советы: дефицит 500 ккал, белок 1.6–2.2 г/кг, кардио + силовые</div>`
                : `<div class="alert alert-success">Советы: профицит 500 ккал, белок 1.6–2.2 г/кг, тренировки с весом</div>`;
            document.getElementById('tips').innerHTML = tips;
        }

        // Поиск еды
        async function searchFood() {
            const query = document.getElementById('food-search').value.trim();
            if (!query) return;

            const res = await fetch(USDA_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, pageSize: 10, api_key: API_KEY })
            });
            const data = await res.json();
            const div = document.getElementById('food-search-results');
            div.innerHTML = '';

            if (data.foods && data.foods.length) {
                data.foods.forEach(food => {
                    const calories = food.foodNutrients.find(n => n.nutrientName === 'Energy')?.value || 0;
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = `${food.description} — ${calories} ккал/100г`;
                    item.onclick = () => addFood(food.description, calories);
                    div.appendChild(item);
                });
            } else {
                div.innerHTML = '<div class="list-group-item text-danger">Ничего не найдено</div>';
            }
        }

        function addFood(name, calories) {
            if (!dailyData[currentDate]) dailyData[currentDate] = [];
            dailyData[currentDate].push({ name, calories });
            localStorage.setItem('dailyData', JSON.stringify(dailyData));
            renderFoods();
            document.getElementById('food-search-results').innerHTML = '';
            document.getElementById('food-search').value = '';
        }

        function removeFood(index) {
            dailyData[currentDate].splice(index, 1);
            localStorage.setItem('dailyData', JSON.stringify(dailyData));
            renderFoods();
        }

        function renderFoods() {
            const list = document.getElementById('food-list');
            list.innerHTML = '';
            let total = 0;
            (dailyData[currentDate] || []).forEach((food, i) => {
                total += food.calories;
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `${food.name} — ${food.calories} ккал 
                    <button class="btn btn-sm btn-danger" onclick="removeFood(${i})">×</button>`;
                list.appendChild(li);
            });
            document.getElementById('total-calories').innerText = `Итого: ${total} ккал`;
            updateChart();
        }

        function loadDay() {
            currentDate = document.getElementById('date').value;
            renderFoods();
            updateChart();
        }

        // График
        function updateChart() {
            const ctx = document.getElementById('calorie-chart').getContext('2d');
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                labels.push(ds.slice(5)); // MM-DD
                const cal = (dailyData[ds] || []).reduce((s, f) => s + f.calories, 0);
                data.push(cal);
            }

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Калории',
                        data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Напоминания
        function addReminder() {
            const text = document.getElementById('reminder-text').value.trim();
            const time = document.getElementById('reminder-time').value;
            if (!text || !time) return;

            const reminder = { text, time, id: Date.now() };
            reminders.push(reminder);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            renderReminders();
            scheduleReminder(reminder);

            document.getElementById('reminder-text').value = '';
            document.getElementById('reminder-time').value = '';
        }

        function removeReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            renderReminders();
        }

        function renderReminders() {
            const list = document.getElementById('reminder-list');
            list.innerHTML = '';
            reminders.forEach(r => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `<strong>${r.time}</strong> — ${r.text}
                    <button class="btn btn-sm btn-danger" onclick="removeReminder(${r.id})">×</button>`;
                list.appendChild(li);
            });
        }

        function scheduleReminder(reminder) {
            const [hours, minutes] = reminder.time.split(':');
            const now = new Date();
            let target = new Date();
            target.setHours(hours, minutes, 0, 0);

            if (target < now) target.setDate(target.getDate() + 1);

            const delay = target - now;

            setTimeout(() => {
                if (Notification.permission === "granted") {
                    new Notification("Напоминание FitLife", { body: reminder.text });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(perm => {
                        if (perm === "granted") {
                            new Notification("Напоминание FitLife", { body: reminder.text });
                        }
                    });
                }
            }, delay);
        }

        // Инициализация
        renderFoods();
        updateChart();
        renderReminders();
        reminders.forEach(scheduleReminder);

        // Запрос разрешения на уведомления
        if (Notification.permission === "default") {
            Notification.requestPermission();
        }
    </script>
</body>
</html>